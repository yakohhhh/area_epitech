#!/bin/bash

# Pre-push hook - VÃ©rifie que tout compile et se lance avant un push
# Teste les installations de dÃ©pendances et les builds

set -e

echo "ğŸš€ Pre-push: VÃ©rifications complÃ¨tes avant push..."

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

print_status() { echo -e "${GREEN}[âœ“]${NC} $1"; }
print_error() { echo -e "${RED}[âœ—]${NC} $1"; }
print_warning() { echo -e "${YELLOW}[!]${NC} $1"; }

FAILED=0

check_service() {
    local SERVICE_NAME=$1
    local SERVICE_PATH=$2
    print_status "VÃ©rification de $SERVICE_NAME..."
    if [ ! -d "$SERVICE_PATH" ]; then
        print_error "$SERVICE_NAME: Dossier introuvable"
        return 1
    fi

    cd "$SERVICE_PATH"

    if [ ! -f "package.json" ]; then
        print_error "$SERVICE_NAME: package.json introuvable"
        cd - > /dev/null
        return 1
    fi

    print_status "$SERVICE_NAME: Installation des dÃ©pendances..."
    if ! npm ci --prefer-offline --no-audit 2>/dev/null && ! npm install --prefer-offline --no-audit 2>/dev/null; then
        print_error "$SERVICE_NAME: Ã‰chec de l'installation des dÃ©pendances"
        cd - > /dev/null
        return 1
    fi

    if [ -f "tsconfig.json" ]; then
        print_status "$SERVICE_NAME: VÃ©rification TypeScript..."
        if ! npx tsc --noEmit 2>/dev/null; then
            print_warning "$SERVICE_NAME: Erreurs TypeScript dÃ©tectÃ©es"
        fi
    fi

    if grep -q '"build"' package.json; then
        print_status "$SERVICE_NAME: Test de build..."
        if ! npm run build 2>/dev/null; then
            print_error "$SERVICE_NAME: Le build a Ã©chouÃ©"
            cd - > /dev/null
            return 1
        fi
    fi

    cd - > /dev/null
    print_status "$SERVICE_NAME: âœ… OK"
    return 0
}

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  VÃ‰RIFICATION DES SERVICES"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

if ! check_service "Backend" "AREA-Project/back"; then
    FAILED=1
fi

echo ""

if ! check_service "Frontend" "AREA-Project/front"; then
    FAILED=1
fi

echo ""

if ! check_service "Mobile" "AREA-Project/mobile"; then
    FAILED=1
fi

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

if [ $FAILED -eq 1 ]; then
    print_error "Certaines vÃ©rifications ont Ã©chouÃ©!"
    echo ""
    print_warning "Voulez-vous forcer le push malgrÃ© les erreurs ? (y/n)"
    read -r response
    if [[ ! "$response" =~ ^[Yy]$ ]]; then
        print_error "Push annulÃ©"
        exit 1
    fi
    print_warning "Push forcÃ© malgrÃ© les erreurs..."
fi

print_status "Pre-push: Toutes les vÃ©rifications sont OK!"
exit 0
